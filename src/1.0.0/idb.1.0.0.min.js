(function(b){b.IDB=function(a,c,d){this.start(a,c,d)};b.IDB.prototype.start=function(a,c,d){var e=this;this.config={};this.setup=a;this.setup.db&&this.setup.version&&this.setup.stores&&this.setup.stores.length?(a=indexedDB.open(this.setup.db,this.setup.version),a.onerror=function(a){"function"===typeof d&&d.call(e,a)},a.onsuccess=function(a){e.db=a.target.result;"function"===typeof c&&c.call(e,a)},a.onupgradeneeded=function(a){for(var c=a.target.result,f,l,h,n=0,b=e.setup.stores.length;n<b;n++){h=
    e.setup.stores[n];c.objectStoreNames.contains(h.name)&&c.deleteObjectStore(h.name);l=c.createObjectStore(h.name,h.keyPath?{keyPath:h.keyPath}:{autoIncrement:!0});for(var m in h.schema)h.schema.hasOwnProperty(m)&&(f=h.schema[m],l.createIndex(m,m,{unique:!(!f||"object"!==typeof f||!f.unique)}))}a.target.transaction.onerror=function(a){"function"===typeof d&&d.call(e,a)}}):"function"===typeof d&&d.call(this,{errorMessage:"Database Name and/or Store is not defined."})};b.IDB.prototype.formatResult=function(a){return a?
{value:a.value,key:a.key}:void 0};b.IDB.prototype.openStore=function(a,c){c&&"readwrite"===c&&"readonly"===c||(c="readwrite");return this.db.transaction([a],c).objectStore(a)};b.IDB.prototype.processRequest=function(a,c,d){var e=this;a.onerror=function(a){"function"===typeof d&&d.call(e,a)};a.onsuccess=function(a){"function"===typeof c&&c.call(e,a)}};b.IDB.prototype.insert=function(a,c,d,e,k){a=this.openStore(d,"readwrite")[c?"put":"add"](a);this.processRequest(a,e,k)};b.IDB.prototype.query=function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         c,d,e,k){var b=this,f=[];d=this.openStore(d,"readonly");d=c?d.index(c):d;a=d.openCursor(a);a.onerror=function(a){"function"===typeof k&&k.call(b,a)};a.onsuccess=function(a){var c=a.target.result;c?(f.push(b.formatResult(c)),c["continue"]()):"function"===typeof e&&e.call(b,a,f)}};b.IDB.prototype.queryMultipleKeys=function(a,c,d,e,b){var g=this,f=a&&"object"===typeof a&&a.length,l,h;f?(b=this.openStore(d,"readonly"),l=[],b=c?b.index(c):b,h=function(b){f?(f--,g.query(IDBKeyRange.only(a[f]),c?c:null,
    d,function(c,d){if(d.length)for(var b=0,e=d.length;b<e;b++)l.push(g.formatResult({value:d[b].value,key:a[f]}));h(c)})):"function"===typeof e&&e.call(g,b,l)},h()):"function"===typeof b&&b.call(g,{errorMessage:"Keys not provided."})};b.IDB.prototype.remove=function(a,c,d,b){a=this.openStore(c,"readwrite")["delete"](a);this.processRequest(a,d,b)};b.IDB.prototype.search=function(a,c,d,e,k){var g=this,f;this.config.blob||(f=function(a){var c=[],b;b=RegExp(a.data.searchTerm,"gi");for(var d=0,e=a.data.data.length,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           f,g;d<e;d++)f=a.data.data[d],(g=f.value[a.data.index]+"")&&g.match(b)&&c.push(f);self.postMessage({result:c})},this.config.blob=new Blob(['self.addEventListener("message",'+f.toString()+")"],{type:"text/javascript"}));this.config.worker||(this.config.worker=new Worker(b.URL.createObjectURL(this.config.blob)));this.config.worker.onerror=k;this.config.worker.onmessage=function(a){"function"===typeof e&&e.call(g,a,a.data.result)};this.query(null,null,d,function(d,b){this.config.worker.postMessage({data:b,
    searchTerm:a,index:c})})};b.IDB.prototype.update=function(a,c,b,e,k){var g=this;c=this.openStore(b,"readwrite").openCursor(IDBKeyRange.only(c));var f=[];c.onerror=function(a){"function"===typeof k&&k.call(g,a)};c.onsuccess=function(c){var b=c.target.result;if(b){for(var d in b.value)b.value.hasOwnProperty(d)&&a[d]&&(b.value[d]=a[d]);b.update(b.value);f.push(g.formatResult(b));b["continue"]()}else"function"===typeof e&&e.call(g,c,f)}}})(window);