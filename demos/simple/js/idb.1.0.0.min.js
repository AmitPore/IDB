(function(window){"use strict";var formatResult,processRequest;window.IDB=function(setup,onDbReady,errorCallback){var instance=this,request;this.config={};this.setup=setup;if(!this.setup.db||!this.setup.version||!this.setup.stores||!this.setup.stores.length){if(typeof errorCallback==="function"){errorCallback.call(this,{errorMessage:"Database Name and/or Store is not defined."})}return}request=window.indexedDB.open(this.setup.db,this.setup.version);request.onerror=function(e){if(typeof errorCallback==="function"){errorCallback.call(instance,e)}};request.onsuccess=function(e){instance.db=e.target.result;if(typeof onDbReady==="function"){onDbReady.call(instance,e)}};request.onupgradeneeded=function(e){var db=e.target.result,column,objectStore,store,i,l,key;for(i=0,l=instance.setup.stores.length;i<l;i++){store=instance.setup.stores[i];if(db.objectStoreNames.contains(store.name)){db.deleteObjectStore(store.name)}objectStore=db.createObjectStore(store.name,store.keyPath?{keyPath:store.keyPath}:{autoIncrement:true});for(key in store.schema){if(store.schema.hasOwnProperty(key)){column=store.schema[key];objectStore.createIndex(key,key,{unique:!!(column&&typeof column==="object"&&column.unique)})}}}e.target.transaction.onerror=function(e){if(typeof errorCallback==="function"){errorCallback.call(instance,e)}}}};window.IDB.prototype.getStoreInfo=function(storeName,successHandler,errorHandler){var instance=this,objectStore=this.openStore(storeName,"readonly"),count=objectStore.count();count.onerror=function(e){if(typeof errorHandler==="function"){errorHandler.call(instance,e)}};count.onsuccess=function(e){if(typeof successHandler==="function"){successHandler.call(instance,e,{store:objectStore,count:e.target.result})}}};window.IDB.prototype.insert=function(value,overwrite,storeName,successHandler,errorHandler){var objectStore=this.openStore(storeName,"readwrite"),request=objectStore[(overwrite?"put":"add")](value);processRequest(request,successHandler,errorHandler)};window.IDB.prototype.openStore=function(storeName,mode){var objectStore,transaction;if(!mode||mode!=="readwrite"||mode!=="readonly"){mode="readwrite"}transaction=this.db.transaction([storeName],mode);objectStore=transaction.objectStore(storeName);return objectStore};window.IDB.prototype.query=function(keyRange,index,storeName,pageIndex,itemsPerPage,direction,successHandler,errorHandler){var instance=this,itemsAdded=0,data=[],directions={"next":"next","nextunique":"nextunique","prev":"prev","prevunique":"prevunique"},objectStore=this.openStore(storeName,"readonly"),advance=pageIndex*itemsPerPage,request;if(!directions[direction]){direction=directions.next}objectStore=index?objectStore.index(index):objectStore;request=objectStore.openCursor(keyRange,direction);request.onerror=function(e){if(typeof errorHandler==="function"){errorHandler.call(instance,e)}};request.onsuccess=function(e){var cursor=e.target.result;if(cursor){if(advance){cursor.advance(advance);advance=0;return}if(!itemsPerPage||(itemsPerPage&&itemsAdded)<itemsPerPage){data.push(formatResult(cursor));itemsAdded++;cursor["continue"]();return}}if(typeof successHandler==="function"){successHandler.call(instance,e,data)}}};window.IDB.prototype.queryMultipleKeys=function(keys,index,storeName,successHandler,errorHandler){var instance=this,count=0,result=[],limit,getNext;if(keys.length){limit=keys&&typeof keys==="object"&&keys.length;result=[];getNext=function(e){var i,l;if(count<limit){instance.query(window.IDBKeyRange.only(keys[count]),index||null,storeName,0,0,function(e,data){if(data.length){for(i=0,l=data.length;i<l;i++){result.push(formatResult({value:data[i].value,key:keys[count]}))}}count++;getNext(e)})}else{if(typeof successHandler==="function"){successHandler.call(instance,e,result)}}};getNext()}else{if(typeof errorHandler==="function"){errorHandler.call(instance,{errorMessage:"Keys not provided."})}}};window.IDB.prototype.remove=function(key,storeName,successHandler,errorHandler){var objectStore=this.openStore(storeName,"readwrite"),request=objectStore["delete"](key);processRequest(request,successHandler,errorHandler)};window.IDB.prototype.update=function(value,key,storeName,successHandler,errorHandler){var instance=this,objectStore=this.openStore(storeName,"readwrite"),request=objectStore.openCursor(IDBKeyRange.only(key)),data=[];request.onerror=function(e){if(typeof errorHandler==="function"){errorHandler.call(instance,e)}};request.onsuccess=function(e){var cursor=e.target.result;if(cursor){for(var item in cursor.value){if(cursor.value.hasOwnProperty(item)&&value[item]){cursor.value[item]=value[item]}}cursor.update(cursor.value);data.push(formatResult(cursor));cursor["continue"]()}else{if(typeof successHandler==="function"){successHandler.call(instance,e,data)}}}};formatResult=function(result){return result?{value:result.value,key:result.key}:undefined};processRequest=function(request,successHandler,errorHandler){var instance=this;request.onerror=function(e){if(typeof errorHandler==="function"){errorHandler.call(instance,e)}};request.onsuccess=function(e){if(typeof successHandler==="function"){successHandler.call(instance,e)}}}})(window);